/*!
 * maptalks.LineAnimPlayer v2.0.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function i(t,e){for(var i=Object.getOwnPropertyNames(e),n=0;n<i.length;n++){var a=i[n],r=Object.getOwnPropertyDescriptor(e,a);r&&r.configurable&&void 0===t[a]&&Object.defineProperty(t,a,r)}return t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):i(t,e))}var s={arrowStyle:null,arrowPlacement:"vertex-last"},o=function(t){function i(e,r){n(this,i);var s=a(this,t.call(this,e,r));return s.type="LineAnimPlayer",s}return r(i,t),i.prototype.createPlayer=function(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];e.Util.isFunction(i)&&(i={},n=i),this.totalCoordinates=this.getCoordinates();var a=i.duration||1e3;this.duration=a,this.totalLength=this.getLength();var r=i.easing||"out";this.unitTime=i.unitTime||1,this.aniCallback=n,this.setCoordinates([]),this.played=0;var s=e.animation.Animation.animate({t:[0,1]},{duration:this.duration,easing:r},function(e){t._step(e)});return this.player=s,this},i.prototype._step=function(t){this.played=this.duration*t.styles.t;var e=this.totalLength,i=this.totalCoordinates;if(!this.getMap())return this.player.finish(),this.setCoordinates(i),void(this.aniCallback&&this.aniCallback(t,i[i.length-1],e-1));var n=this._drawAnimFrame(t.styles.t,this.duration,e,i),a=n?n[n.length-1]:i[0];this.aniCallback&&this.aniCallback(t,a,this._animIdx)},i.prototype.setSpeed=function(t){this.unitTime=this.unitTime*t,this._resetPlayer()},i.prototype._resetPlayer=function(){var t=this.player&&"running"===this.player.playState;t&&this.player.pause(),this._createPlayer(),t&&this.player.play()},i.prototype._createPlayer=function(){var t=(this.duration-this.played)/this.unitTime;this.player=e.animation.Animation.animate({t:[this.played/this.duration,1]},{speed:t,easing:"linear"},function(t){this._step(t)}.bind(this))},i.prototype.cancel=function(){return this.player?(this.played=0,this._animIdx=0,this._animLenSoFar=0,this._createPlayer(),this.player.cancel(),this._step({styles:{t:0}}),this.fire("playcancel"),this):null},i.prototype.play=function(){return this.player?(this.player.play(),this.fire("playstart"),this):(console.log("You should call createPlayer method to play it!"),this)},i.prototype.pause=function(){return this.player.pause(),this.fire("playpause"),this},i.prototype.finish=function(){return this.player.finish(),this.fire("playfinish"),this},i.prototype._drawAnimFrame=function(t,i,n,a){if(0===t)return this.setCoordinates([]),null;var r=this.getMap(),s=t*n;this._animIdx||(this._animIdx=0,this._animLenSoFar=0,this.show());var o,h,l=0;for(o=this._animIdx,h=a.length;o<h-1&&(l=r.computeLength(a[o],a[o+1]),!(this._animLenSoFar+l>s));o++)this._animLenSoFar+=l;if(this._animIdx=o,this._animIdx>=h-1)return this.setCoordinates(a),this.unitTime=1,this.fire("playfinish"),a;this.fire("playing");var p=this._animIdx,u=a[p],y=a[p+1],c=s-this._animLenSoFar,f=c/l,d=u.x+(y.x-u.x)*f,m=u.y+(y.y-u.y)*f,_=new e.Coordinate(d,m),g=a.slice(0,this._animIdx+1);return g.push(_),this.setCoordinates(g),g},i}(e.LineString);o.mergeOptions(s),o.registerJSONType("LineAnimPlayer"),t.LineAnimPlayer=o,Object.defineProperty(t,"__esModule",{value:!0})});