/*!
 * maptalks.LineAnimPlayer v2.0.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],i):i(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,i){"use strict";function e(t,i){for(var e=Object.getOwnPropertyNames(i),n=0;n<e.length;n++){var a=e[n],r=Object.getOwnPropertyDescriptor(i,a);r&&r.configurable&&void 0===t[a]&&Object.defineProperty(t,a,r)}return t}function n(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function a(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i}function r(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):e(t,i))}var s={arrowStyle:null,arrowPlacement:"vertex-last"},o=function(t){function e(i,r){n(this,e);var s=a(this,t.call(this,i,r));return s.type="LineAnimPlayer",s}return r(e,t),e.prototype.createPlayer=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];i.Util.isFunction(e)&&(e={},n=e);var a=this.getCoordinates();this.totalCoordinates=a;var r=e.duration||1e3;this.duration=r;var s=this.getLength();this.totalLength=s;var o=e.easing||"out";this.unitTime=e.unitTime||1,this.aniCallback=n,this.setCoordinates([]),this.played=0;var h=i.animation.Animation.animate({t:[0,1]},{duration:this.duration,easing:o},function(i){t._step(i)});return this.player=h,this},e.prototype._step=function(t){this.played=this.duration*t.styles.t;var i=this.totalLength,e=this.totalCoordinates;if(!this.getMap())return this.player.finish(),this.setCoordinates(e),void(this.aniCallback&&this.aniCallback(t,e[e.length-1],i-1));var n=this._drawAnimFrame(t.styles.t,this.duration,i,e),a=n?n[n.length-1]:e[0];this.aniCallback&&this.aniCallback(t,a,this._animIdx)},e.prototype.setSpeed=function(t){this.unitTime=this.unitTime*t,this._resetPlayer()},e.prototype._resetPlayer=function(){var t=this.player&&"running"===this.player.playState;t&&this.player.finish(),this._createPlayer(),t&&this.player.play()},e.prototype._createPlayer=function(){var t=(this.duration-this.played)/this.unitTime;this.player=i.animation.Animation.animate({t:[this.played/this.duration,1]},{speed:t,easing:"linear"},function(t){this._step(t)}.bind(this))},e.prototype.cancel=function(){return this.player?(this.player.cancel(),this.played=0,this._animIdx>0&&(this._animIdx=0),this._animLenSoFar>0&&(this._animLenSoFar=0),this._createPlayer(),this._step({styles:{t:0}}),this.fire("playcancel"),this):null},e.prototype.play=function(){return this.player?(this.player.play(),this.fire("playstart"),this):(console.log("You should call createPlayer method to play it!"),this)},e.prototype.pause=function(){return this.player.pause(),this.fire("playpause"),this},e.prototype.finish=function(){return this.player.finish(),this._step({styles:{t:1}}),this.fire("playfinish"),this},e.prototype._drawAnimFrame=function(t,e,n,a){if(0===t)return this.setCoordinates([]),null;var r=this.getMap(),s=t*n;this._animIdx||(this._animIdx=0,this._animLenSoFar=0,this.show());var o,h,l=0;for(o=this._animIdx,h=a.length;o<h-1&&(l=r.computeLength(a[o],a[o+1]),!(this._animLenSoFar+l>s));o++)this._animLenSoFar+=l;if(this._animIdx=o,this._animIdx>=h-1)return this.setCoordinates(a),this.unitTime=1,this.fire("playfinish"),a;this.fire("playing");var p=this._animIdx,u=a[p],y=a[p+1],c=s-this._animLenSoFar,f=c/l,d=u.x+(y.x-u.x)*f,m=u.y+(y.y-u.y)*f,_=new i.Coordinate(d,m),g=a.slice(0,this._animIdx+1);return g.push(_),this.setCoordinates(g),g},e}(i.LineString);o.mergeOptions(s),o.registerJSONType("LineAnimPlayer"),t.LineAnimPlayer=o,Object.defineProperty(t,"__esModule",{value:!0})});